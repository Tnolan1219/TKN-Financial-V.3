<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1039930282091803"
     crossorigin="anonymous"></script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TKN Financial ‚Äî Profile</title>
  <meta name="description" content="MilFi Profile ‚Äî local-only profile, calculator usage meter, plan, and preferences. Integrated with site-wide usage counters." />

 <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #111827;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --accent-soft: rgba(96,165,250,0.3);
      --input: #020617;
      --good: #22c55e;
      --radius: 16px;
      --shadow: 0 18px 45px rgba(15,23,42,0.65);
      --brand-gradient: linear-gradient(135deg,#60a5fa 0%,#818cf8 40%,#22c1c3 100%);
      --glass-blur: blur(18px);
      --pattern: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="40" height="40" fill="%230f172a"/><circle cx="20" cy="20" r="1.5" fill="%2360a5fa" opacity="0.10"/><circle cx="10" cy="10" r="1.5" fill="%2360a5fa" opacity="0.10"/><circle cx="30" cy="30" r="1.5" fill="%2360a5fa" opacity="0.10"/></svg>');
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      color: var(--text);
      background:
        var(--pattern),
        radial-gradient(1200px 600px at -10% -10%, rgba(96,165,250,.14), transparent 60%),
        radial-gradient(900px 420px at 110% -10%, rgba(129,140,248,.12), transparent 55%),
        linear-gradient(180deg, var(--bg), #020617 65%);
      min-height: 100vh;
    }

main.main {
  max-width: 960px;
  margin: 0 auto;
  padding: 32px 24px 40px;
}

.card {
  margin: 0 auto;
  max-width: 800px;
}

    header.page-header {
      margin-bottom: 22px;
    }

    .eyebrow {
      font-size: 0.8rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }

    h1 {
      margin: 0;
      font-size: 2.1rem;
      font-weight: 800;
      color: #f9fafb;
    }

    .page-subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 6px;
      max-width: 620px;
    }

    /* Grid + cards */

    .grid.two {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1.1fr);
      gap: 20px;
      align-items: stretch;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(96,165,250,0.18), transparent 60%),
                  radial-gradient(circle at bottom right, rgba(56,189,248,0.16), transparent 55%),
                  var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 20px;
      border: 1px solid rgba(31,41,55,0.9);
      position: relative;
      overflow: hidden;
      backdrop-filter: var(--glass-blur);
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        border-color 0.15s ease,
        background 0.15s ease;
        margin: 0 auto;
        max-width: 800px;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 55px rgba(15,23,42,0.9);
      border-color: var(--accent-soft);
    }

    .head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 14px;
      gap: 16px;
    }

    .head-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .head-title span {
      color: var(--accent);
    }

    .body {
      font-size: 0.9rem;
    }

    /* Profile summary */

    .avatar-wrap {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .avatar {
      width: 76px;
      height: 76px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #1d4ed8, #020617);
      border: 2px solid rgba(148,163,184,0.8);
      display: grid;
      place-items: center;
      overflow: hidden;
      margin-bottom: 0;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .initial {
      font-size: 1.6rem;
      font-weight: 900;
      color: #e5edff;
    }

    #nameLine {
      font-weight: 700;
      font-size: 1.1rem;
    }

    #metaLine,
    #stationLine {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 5px 11px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(96,165,250,0.7);
      font-size: 0.75rem;
      color: var(--accent);
      white-space: nowrap;
    }

    .chip::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 6px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.25);
    }

    .ring {
      position: relative;
      width: 110px;
      height: 110px;
    }

    .ring svg {
      transform: rotate(-90deg);
    }

    .center {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 1rem;
    }

    .usage-big {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .small,
    .muted {
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* Buttons */

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      background: var(--brand-gradient);
      color: #020617;
      font-weight: 700;
      font-size: 0.9rem;
      border: none;
      box-shadow: 0 12px 30px rgba(37,99,235,0.6);
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        filter 0.15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 15px 36px rgba(37,99,235,0.7);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 7px 18px rgba(15,23,42,0.9);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.65);
      color: var(--text);
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(15,23,42,0.9);
      box-shadow: 0 10px 30px rgba(15,23,42,0.9);
    }

    /* Tiny buttons for JSON tools */

    .btn-tiny {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease;
    }

    .btn-tiny:hover {
      background: rgba(15,23,42,1);
      border-color: rgba(96,165,250,0.7);
      color: var(--text);
    }

    .btn-tiny-label {
      cursor: pointer;
    }

    /* Inputs */

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    input,
    select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at top, rgba(30,64,175,0.3), transparent 55%), var(--input);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      width: 100%;
      min-height: 40px;
      transition:
        border-color 0.16s ease,
        box-shadow 0.16s ease,
        background 0.16s ease;
    }

    input::placeholder,
    select::placeholder {
      color: rgba(148,163,184,0.8);
    }

    input:focus,
    select:focus {
      border-color: rgba(96,165,250,0.9);
      box-shadow:
        0 0 0 1px rgba(37,99,235,0.8),
        0 0 0 5px rgba(37,99,235,0.25);
      background: radial-gradient(circle at top, rgba(59,130,246,0.35), transparent 60%), #020617;
    }

    input[type="file"] {
      padding: 7px 8px;
      font-size: 0.8rem;
      background: rgba(15,23,42,0.95);
    }

    #status {
      display: inline-block;
      font-size: 0.8rem;
      margin-left: 4px;
      color: var(--good);
    }

    /* Bottom card layout */

    .bottom-card {
      margin-top: 22px;
    }

    .bottom-grid {
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap: 18px;
      align-items: flex-start;
      margin-top: 6px;
    }

    #usageTable2 {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 6px 8px;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    #usageTable2 div {
      padding: 6px 7px;
      border-radius: 8px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.95);
    }

    #usageTable2 div:nth-child(odd) {
      border-right: none;
      border-radius: 8px 0 0 8px;
    }

    #usageTable2 div:nth-child(even) {
      text-align: right;
      border-left: none;
      border-radius: 0 8px 8px 0;
    }

    .data-tools-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    footer {
      text-align: center;
      padding: 18px 18px 26px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      .grid.two {
        grid-template-columns: 1fr;
      }
      .bottom-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      main.main {
        padding: 22px 14px 28px;
      }
      h1 {
        font-size: 1.7rem;
      }
      .row {
        grid-template-columns: 1fr;
      }
      .card {
        padding: 16px 14px 18px;
      }
    }
  </style>


  
  <script type="module">
    import {
      initState, getActiveUserId, setActiveUserId,
      getPlan, setPlan, getUsage
    } from "../js/entitlements.js";

    function renderProfile() {
      initState();
      document.getElementById('profileUserId').value = getActiveUserId();
      document.getElementById('planFree').checked = getPlan() === "free";
      document.getElementById('planPro').checked = getPlan() === "pro";
      const usage = getUsage("_global");
      document.getElementById('usageMonth').textContent = usage.month;
      document.getElementById('usageTotal').textContent = usage.total;
      const tbody = document.getElementById('usageByCalc');
      tbody.innerHTML = '';
      Object.entries(usage.byCalc).forEach(([calc, count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${calc}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
      // Update plan badge from entitlements.js
      const plan = getPlan();
      const badge = document.getElementById('planBadge');
      badge.textContent = "Plan: " + (plan === "pro" ? "Pro" : "Free");
      badge.style.background = plan === "pro" ? "#123165" : "rgba(255,255,255,.06)";
      badge.style.color = plan === "pro" ? "#ffd166" : "#bed4ff";
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderProfile();
      document.getElementById('saveProfile').onclick = () => {
        setActiveUserId(document.getElementById('profileUserId').value || "default");
        setPlan(document.getElementById('planPro').checked ? "pro" : "free");
        renderProfile();
        document.getElementById('saveMsg').textContent = "Saved!";
        setTimeout(()=>{document.getElementById('saveMsg').textContent='';},1500);
      };
      window.addEventListener("milfi:planChanged", renderProfile);
      window.addEventListener("milfi:usageUpdated", renderProfile);
    });
  </script>
</head>
<body>
  <div style="position:fixed;top:16px;left:16px;z-index:50;">
  <a href="https://valentorfinancial.org/" class="btn" style="padding:6px 12px;font-size:0.8rem;">Home</a>
  </div>

  
  <div class="orb one"></div>
  <div class="orb two"></div>

  <header>
    <div class="container bar">
      <div class="brand"><span aria-hidden>üõ°Ô∏è</span><span>TKN Financial</span><span class="chip" id="hello"></span></div>
      <!-- Single nav back to home (kept minimal per your spec) -->
      <a class="home" href="https://tnolan1219.github.io/TKN-Financial-V.3/">Home</a>
    </div>
  </header>

  <main class="container">
    <div class="grid two">

      <!-- LEFT: Profile + Usage KPI (keeps integration with other pages) -->
      <section class="card">
        <div class="head">
          <div class="avatar-wrap">
            <div class="avatar" id="avatarBox"><span class="initial" id="avatarInitial">?</span></div>
            <div>
              <div style="font-size:1.2rem;font-weight:900" id="nameLine">Your Name</div>
              <div class="small" id="metaLine">Branch ‚Ä¢ Paygrade</div>
              <div class="small" id="stationLine">Duty: ‚Äì ‚Ä¢ ETS: ‚Äì</div>
            </div>
          </div>
          <!-- Plan badge now always reflects entitlements.js status -->
          <span class="chip" id="planBadge" aria-live="polite">Plan: Free</span>
        </div>
        <div class="body">
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
            <div class="ring" aria-label="Monthly usage ring">
              <svg width="120" height="120">
                <circle cx="60" cy="60" r="52" stroke="#1f2a41" stroke-width="12" fill="none"></circle>
                <circle id="ringFg" cx="60" cy="60" r="52" stroke="#60a5fa" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="0 999"></circle>
              </svg>
              <div class="center" id="ringCenter">0%</div>
            </div>
            <div>
              <div style="font-size:2rem;font-weight:900" id="usageBig">0 / 50</div>
              <div class="small" id="usageNote">Free members can calculate up to 50 times per month.</div>
            </div>
          </div>
        </div>
      </section>




      <section class="card">
  <div class="head">Sign in & Preferences</div>
  <div class="body">
    <!-- Google Sign-In Controls (from app.js, unchanged) -->
    <div class="row">
      <button class="btn" id="signin">Login/Signup</button>

      <button class="btn" id="signout" style="display:none;">Sign out</button>
    </div>

    <!-- User Info after sign in -->
    <div id="userBox">
      <div class="row">
        <img id="avatar" class="avatar" alt="">
        <div>
          <div><strong id="displayName"></strong></div>
          <div id="email" class="muted"></div>
          <div id="uid" class="muted" style="font-size:12px; color:#666;"></div>
        </div>
      </div>

      <!-- Preferences Section -->
      <h3>Your Preferences</h3>
      <div class="row">
        <div>
          <label for="fullName">Full name</label>
          <input id="fullName" placeholder="e.g., Thomas Nolan" />
        </div>
      </div>
     
       
        <div>
          <label for="avatarInput">Avatar</label>
          <input type="file" id="avatarInput" accept="image/*" />
          <div class="small">Stays on this device.</div>
        </div>
      </div>
      <div class="row">
        <label for="nickname"><strong>Nickname:</strong></label>
        <input id="nickname" type="text" placeholder="e.g., Thomas" />
      </div>
      <div class="row">
        <label for="favoriteCity"><strong>State:</strong></label>
        <input id="favoriteCity" type="text" placeholder="e.g., Maryland" />
      </div>
      <div class="row">
        <label for="Service Branch"><strong>Service Branch:</strong></label>
        <select id="Service Branch">
          <option value="">Select your branch</option>
          <option value="Army">Army</option>
          <option value="Navy">Navy</option>
          <option value="Marine Corps">Marine Corps</option>
          <option value="Air Force">Air Force</option>
          <option value="Space Force">Space Force</option>
          <option value="Coast Guard">Coast Guard</option>
          <option value="Guard/Reserve">Guard/Reserve</option>
        </select>
      </div>
      <div class="row">
          <label for="paygrade"><strong>Rank / Paygrade:</strong></label>
          <select id="paygrade">
            <option value="">Select your rank</option>
            <optgroup label="Enlisted">
              <option value="E-1">E-1</option>
              <option value="E-2">E-2</option>
              <option value="E-3">E-3</option>
              <option value="E-4">E-4</option>
              <option value="E-5">E-5</option>
              <option value="E-6">E-6</option>
              <option value="E-7">E-7</option>
              <option value="E-8">E-8</option>
              <option value="E-9">E-9</option>
            </optgroup>
            <optgroup label="Warrant Officer">
              <option value="W-1">W-1</option>
              <option value="W-2">W-2</option>
              <option value="W-3">W-3</option>
              <option value="W-4">W-4</option>
              <option value="W-5">W-5</option>
            </optgroup>
            <optgroup label="Commissioned Officer">
              <option value="O-1">O-1</option>
              <option value="O-2">O-2</option>
              <option value="O-3">O-3</option>
              <option value="O-4">O-4</option>
              <option value="O-5">O-5</option>
              <option value="O-6">O-6</option>
              <option value="O-7">O-7</option>
              <option value="O-8">O-8</option>
              <option value="O-9">O-9</option>
              <option value="O-10">O-10</option>
            </optgroup>
          </select>
        </div>

      <div class="row">
        <button class="btn" id="saveProfile">Save Profile</button>
        <span id="status" style="margin-left:8px; color:#0a0;"></span>
      </div>
    </div>
  </div>
</section>

<!-- Keep app.js Firebase logic intact -->
<script type="module" src="./app.js"></script>
    </div>

    <!-- Plan & data management (kept for integration; minimal UI) -->
    <section class="card" style="margin-top:16px">
      <div class="head">Plan & Data</div>
      <div class="body">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <button class="btn ghost" id="downgrade">Free</button>
          <button class="btn" id="upgrade">Go Pro</button>
          <span class="small">Promo: use <b>TKN-Fi Pro</b> in other tools if available.</span>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <input id="importAll" type="file" accept="application/json" style="display:none" />
          <button class="btn ghost" id="clearAll">Clear</button>
        </div>
      </div>
    </section>

    <!-- Read-only usage breakdown (no quick links) -->
    <div class="card">
      <div class="head">Usage Breakdown</div>
      <div class="body">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1">
            <div style="font-size:1.2rem;font-weight:900" id="usageBig2">0</div>
            <div class="small" id="usageNote2">Free members can calculate up to 50 times per month.</div>
          </div>
          <div class="ring" aria-label="Monthly usage ring">
            <svg width="120" height="120">
              <circle cx="60" cy="60" r="52" stroke="#1f2a41" stroke-width="12" fill="none"></circle>
              <circle id="ringFg2" cx="60" cy="60" r="52" stroke="#60a5fa" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="0 999"></circle>
            </svg>
            <div class="center" id="ringCenter2">0%</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <b>Per-tool usage:</b>
          <div id="usageTable2" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"></div>
        </div>
      </div>
    </div>

  <footer>¬© <span id="year"></span> TKN-Fi ‚Äî Profile</footer>
  <script type="module">
    import {
      initState, getActiveUserId, setActiveUserId,
      getPlan, setPlan, getUsage
    } from "../js/entitlements.js";

    function renderProfile() {
      initState();
      document.getElementById('profileUserId').value = getActiveUserId();
      document.getElementById('planFree').checked = getPlan() === "free";
      document.getElementById('planPro').checked = getPlan() === "pro";
      const usage = getUsage("_global");
      document.getElementById('usageMonth').textContent = usage.month;
      document.getElementById('usageTotal').textContent = usage.total;
      const tbody = document.getElementById('usageByCalc');
      tbody.innerHTML = '';
      Object.entries(usage.byCalc).forEach(([calc, count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${calc}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
      // Update plan badge from entitlements.js
      const plan = getPlan();
      const badge = document.getElementById('planBadge');
      badge.textContent = "Plan: " + (plan === "pro" ? "Pro" : "Free");
      badge.style.background = plan === "pro" ? "#123165" : "rgba(255,255,255,.06)";
      badge.style.color = plan === "pro" ? "#ffd166" : "#bed4ff";
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderProfile();
      document.getElementById('saveProfile').onclick = () => {
        setActiveUserId(document.getElementById('profileUserId').value || "default");
        setPlan(document.getElementById('planPro').checked ? "pro" : "free");
        renderProfile();
        document.getElementById('saveMsg').textContent = "Saved!";
        setTimeout(()=>{document.getElementById('saveMsg').textContent='';},1500);
      };
      window.addEventListener("milfi:planChanged", renderProfile);
      window.addEventListener("milfi:usageUpdated", renderProfile);
    });
  </script>
  <script>
    // ===== Keys shared across the site =====
    const PROFILE_KEY = 'milfi_profile_v1';
    const PLAN_KEY    = 'milfi_plan_v1';
    // Site-wide shared usage counter that other calculators increment
    const SHARED_USAGE_KEY = 'milfi_calc_usage'; // {month:"YYYY-MM", total:Number, days:{YYYY-MM-DD:true}}
    const SHARED_BY_TOOL_KEY = 'milfi_calc_usage_byTool'; // {tsp:Number,budget:Number,va:Number,starter:Number,toolkit:Number,...}

    // Fallback (legacy local page counter) to preserve backward compat
    const LOCAL_USAGE_KEY = 'milfi_usage_v1';

    const TOOLS_LABELS = { tsp:'TSP Planner', budget:'Budget', va:'VA Estimator', starter:'Career Starter', toolkit:'All-in-One Toolkit' };

    const $ = (id)=>document.getElementById(id);
    const year = $('year'); year.textContent = new Date().getFullYear();

    // ===== Profile state =====
    function readJSON(k, d){ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}catch{return d} }
    function writeJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

    function initials(name){ if(!name) return '?'; const parts=name.trim().split(/\s+/).slice(0,2); return parts.map(p=>p[0]?.toUpperCase()||'').join('')||'?'; }

    function applyTheme(){ const p=readJSON(PROFILE_KEY,{}); const t=p.theme||'system'; const root=document.documentElement; if(t==='dark') root.dataset.theme='dark'; else if(t==='light') root.dataset.theme='light'; else root.removeAttribute('data-theme'); }

    function renderProfile(){
      const p=readJSON(PROFILE_KEY,{});
      $('nameLine').textContent = p.fullName || 'Your Name';
      $('metaLine').textContent = (p.branch||'‚Äî') + ' ‚Ä¢ ' + (p.paygrade||'‚Äî');
      $('stationLine').textContent = 'Duty: ' + (p.station||'‚Äî') + ' ‚Ä¢ ETS: ' + (p.ets||'‚Äî');
      $('hello').textContent = p.fullName ? ('Hi, '+p.fullName.split(' ')[0]) : '';
      if(p.avatar){ $('avatarBox').innerHTML = '<img alt="Avatar" src="'+p.avatar+'" />'; }
      else{ $('avatarBox').innerHTML = '<span class="initial">'+initials(p.fullName)+'</span>'; }
      // form
      $('fullName').value=p.fullName||''; $('email').value=p.email||''; $('branch').value=p.branch||''; $('paygrade').value=p.paygrade||''; $('station').value=p.station||''; $('ets').value=p.ets||''; $('theme').value=p.theme||'system';
      applyTheme();
    }

    function saveProfile(){
      const p=readJSON(PROFILE_KEY,{});
      p.fullName=$('fullName').value.trim();
      p.email=$('email').value.trim();
      p.branch=$('branch').value; p.paygrade=$('paygrade').value;
      p.station=$('station').value.trim(); p.ets=$('ets').value;
      p.theme=$('theme').value;
      writeJSON(PROFILE_KEY,p);
      renderProfile();
      $('saveMsg').textContent='Saved ‚úì'; setTimeout(()=>$('saveMsg').textContent='',1500);
    }

    $('avatarInput').addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
      r.onload=()=>{ const p=readJSON(PROFILE_KEY,{}); p.avatar=r.result; writeJSON(PROFILE_KEY,p); renderProfile(); };
      r.readAsDataURL(f);
    });
    $('saveProfile').addEventListener('click', saveProfile);
    ;['fullName','email','branch','paygrade','station','ets','theme'].forEach(id=>$(id).addEventListener('change', saveProfile));

    // ===== Plan =====
    function renderPlan(){
      // Sync with Dashboard2.html plan key
      let tier = 'free';
      if(localStorage.getItem('milfi_plan')){
        tier = localStorage.getItem('milfi_plan').toLowerCase() === 'pro' ? 'pro' : 'free';
      } else {
        const plan=readJSON(PLAN_KEY,{}); tier=plan.tier||'free';
      }
      // Write back to both keys for cross-page sync
      localStorage.setItem('milfi_plan', tier==='pro'?'Pro':'Free');
      const plan=readJSON(PLAN_KEY,{}); plan.tier=tier; writeJSON(PLAN_KEY,plan);
      const badge=$('planBadge'); badge.textContent='Plan: '+(tier==='pro'?'Pro':'Free'); badge.style.background = tier==='pro'?'#123165':'rgba(255,255,255,.06)'; badge.style.color=tier==='pro'?'#ffd166':'#bed4ff';
    }
    function setPlan(tier){
      // Sync with Dashboard2.html plan key
      localStorage.setItem('milfi_plan', tier==='pro'?'Pro':'Free');
      const plan=readJSON(PLAN_KEY,{}); plan.tier=tier; plan.since=plan.since||new Date().toISOString(); writeJSON(PLAN_KEY,plan);
      renderPlan(); renderUsage();
    }
    $('upgrade').addEventListener('click', ()=>setPlan('pro'));
    $('downgrade').addEventListener('click', ()=>setPlan('free'));

    // ===== Usage (read shared counters other pages update) =====
    function monthNow(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }

    function readSharedUsage(){
      let u = readJSON(SHARED_USAGE_KEY,{});
      const m = monthNow();
      if(u.month !== m){ u = {month:m,total:0,days:{}}; }
      const byTool = readJSON(SHARED_BY_TOOL_KEY,{});
      return {u, byTool};
    }

    function fallbackLocalUsage(){
      // Back-compat for older pages that used LOCAL_USAGE_KEY structure
      let u = readJSON(LOCAL_USAGE_KEY,{});
      if(!u.month) u.month = monthNow();
      u.days = u.days || {};
      u.total = u.total || 0;
      u.byTool = u.byTool || {};
      return {u, byTool:u.byTool};
    }

    function renderUsage(){
      // Sync usage with Dashboard2.html
      let tier = 'free';
      if(localStorage.getItem('milfi_plan')){
        tier = localStorage.getItem('milfi_plan').toLowerCase() === 'pro' ? 'pro' : 'free';
      } else {
        const plan=readJSON(PLAN_KEY,{}); tier=plan.tier||'free';
      }
      // Get usage from Dashboard2.html key
      let used = 0;
      if(localStorage.getItem('milfi_uses')){
        used = parseInt(localStorage.getItem('milfi_uses'),10)||0;
      } else {
        let {u} = readSharedUsage(); used = u.total||0;
      }
      const limit = tier==='pro' ? Infinity : 25;
      const pct = limit===Infinity?100:Math.min(100, Math.round((used/limit)*100));
      $('usageBig').textContent = used + ' / ' + (limit===Infinity?'‚àû':limit);
      $('usageNote').textContent = tier==='pro' ? 'Pro: unlimited uses' : ('Free limit: '+(limit===Infinity?'‚àû':limit)+'/month');
      const r=52; const C=2*Math.PI*r; const dash = limit===Infinity?C:(C*(pct/100));
      $('ringFg').setAttribute('stroke-dasharray', dash+' '+(C-dash));
      $('ringCenter').textContent = limit===Infinity?'‚àû':(pct+'%');

      // Days active last 7
      const days=u.days||{}; const now=new Date(); let cnt=0; for(let i=0;i<7;i++){ const d=new Date(now); d.setDate(now.getDate()-i); const k=d.toISOString().slice(0,10); if(days[k]) cnt++; }
      $('daysActive').textContent = 'Days active last 7: '+cnt;

      // Table of per-tool counts (read-only)
      const table=$('usageTable'); table.innerHTML='';
      const entries = Object.keys(TOOLS_LABELS).map(k=>[TOOLS_LABELS[k], byTool[k]||0]);
      entries.forEach(([label,val])=>{
        const l=document.createElement('div'); l.textContent=label; table.appendChild(l);
        const v=document.createElement('div'); v.textContent=val; v.style.textAlign='right'; table.appendChild(v);
      });
    }

    // --- Connect to shared calculator usage counter ---
function updateCalcUsage() {
  let u = JSON.parse(localStorage.getItem('milfi_calc_usage')||'{}');
  const m = new Date().toISOString().slice(0,7);
  if(u.month !== m) u = {month:m, total:0};
  const used = u.total || 0;
  const limit = 50; // Or pull from plan if needed
  document.getElementById('usageBig').textContent = used + ' / ' + limit;
  document.getElementById('planBadge').textContent = (used >= limit ? 'Plan: Limit Reached' : 'Plan: Free');
}
window.addEventListener('storage', updateCalcUsage);
document.addEventListener('DOMContentLoaded', updateCalcUsage);

    // --- Connect to dashboard usage tracking ---
function updateDashboardUsage() {
  // Total usage
  const total = parseInt(localStorage.getItem('milfi_uses')||'0',10);
  const limit = localStorage.getItem('milfi_plan')==='Pro' ? 'Unlimited' : '25';
  document.getElementById('usageBig').textContent = total + ' / ' + limit;
  document.getElementById('planBadge').textContent = (localStorage.getItem('milfi_plan')==='Pro' ? 'Plan: Pro' : 'Plan: Free');
  // Per-tool usage (optional, can be shown in chips or a table)
  const tools = [
    {key:'milfi_uses_toolkit', label:'Toolkit'},
    {key:'milfi_uses_budget', label:'Budget'},
    {key:'milfi_uses_tsp', label:'TSP'},
    {key:'milfi_uses_va', label:'VA Loan'},
    {key:'milfi_uses_starter', label:'Starter Loan'},
    {key:'milfi_uses_fire', label:'FIRE'}
  ];
  let toolStr = tools.map(t => `${t.label}: ${parseInt(localStorage.getItem(t.key)||'0',10)}`).join(' | ');
  let chip = document.getElementById('usageChip');
  if(chip) chip.innerHTML = 'Uses this month: <span id="usageBig">' + total + ' / ' + limit + '</span><br><span style="font-size:12px;color:#94a3b8">' + toolStr + '</span>';
}
window.addEventListener('storage', updateDashboardUsage);
document.addEventListener('DOMContentLoaded', updateDashboardUsage);

    // ===== Data export/import/clear =====
    $('exportAll').addEventListener('click', ()=>{
      const dump = {
        profile: readJSON(PROFILE_KEY,{}),
        plan: readJSON(PLAN_KEY,{}),
        shared_usage: readJSON(SHARED_USAGE_KEY,{}),
        shared_byTool: readJSON(SHARED_BY_TOOL_KEY,{})
      };
      const blob=new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='milfi_profile.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('importAll').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return; try{ const txt=await f.text(); const obj=JSON.parse(txt);
        if(obj.profile) writeJSON(PROFILE_KEY,obj.profile);
        if(obj.plan) writeJSON(PLAN_KEY,obj.plan);
        if(obj.shared_usage) writeJSON(SHARED_USAGE_KEY,obj.shared_usage);
        if(obj.shared_byTool) writeJSON(SHARED_BY_TOOL_KEY,obj.shared_byTool);
        renderProfile(); renderPlan(); renderUsage(); alert('Imported ‚úì');
      }catch{ alert('Import failed'); } finally { e.target.value=''; }
    });
    $('clearAll').addEventListener('click', ()=>{ if(confirm('Clear all MilFi profile data on this device?')){ localStorage.removeItem(PROFILE_KEY); localStorage.removeItem(PLAN_KEY); /* do not clear shared counters here */ renderProfile(); renderPlan(); renderUsage(); }});

    // ===== Init =====
    if(!readJSON(PLAN_KEY,{}).tier){ writeJSON(PLAN_KEY,{tier:'free', since:new Date().toISOString()}); }
    renderProfile();
    renderPlan();
    renderUsage();
  </script>
  <script>
    function milfiProfile(getKey, setValue) {
      let profile = {};
      try { profile = JSON.parse(localStorage.getItem('milfi_profile') || '{}'); } catch(e) {}
      if (typeof getKey === 'string') {
        if (setValue !== undefined) {
          profile[getKey] = setValue;
          localStorage.setItem('milfi_profile', JSON.stringify(profile));
          return setValue;
        }
        return profile[getKey];
      }
      return profile;
    }
    function updateProfileModeStatus() {
      const mode = milfiProfile('mode') || 'free';
      document.getElementById('profileMode').value = mode;
      document.getElementById('profileModeStatus').textContent =
        mode === 'pro' ? 'Pro Mode (Unlimited): No usage limits.' : 'Free Mode: Usage limits apply.';
    }
    document.getElementById('profileMode').addEventListener('change', function() {
      milfiProfile('mode', this.value);
      updateProfileModeStatus();
    });
    updateProfileModeStatus();
  </script>
</body>
</html>


















