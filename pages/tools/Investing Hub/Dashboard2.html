<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MilFi ‚Äî Finance Dashboard (Integrated)</title>
  <meta name="description" content="Consolidated snapshot of MilFi tools ‚Äî budget, FIRE, TSP, starter loan ‚Äî plus plan/usage. 100% localStorage, no external libs." />
  <style>
    :root{ --bg:#0b1220; --surface:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --brand:#60a5fa; --ring:#1d4ed8; --ok:#34d399; --warn:#fbbf24; --bad:#ef476f; --shadow:0 12px 40px rgba(0,0,0,.35); --max:1200px; --r:14px; }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),#0b1020 40%,#0a0f1a);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max);margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:1.2fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}
    @media (max-width:980px){.grid.two,.grid.three{grid-template-columns:1fr}}
    header{position:sticky;top:0;z-index:50;background:rgba(2,6,23,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 24px}
    .brand{display:flex;align-items:center;gap:10px}
    .badge{padding:.22rem .5rem;border-radius:999px;background:#0b2c50;border:1px solid #1e3a8a;color:#93c5fd;font-size:.75rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.65rem 1rem;border-radius:999px;border:1px solid #2f3b4e;background:#16214a;color:var(--text);font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#2d50b9,#1b2a6f);border-color:#3551c9}
    .btn.danger{background:#3a0f1f;border-color:#5b1930}
    .btn.ghost{background:transparent}
    .card{background:linear-gradient(180deg,#0c1427,#0b1324);border:1px solid #1f2a41;border-radius:var(--r);box-shadow:var(--shadow)}
    .card .head{padding:12px 16px;border-bottom:1px solid #1e293b;font-weight:800;background:rgba(255,255,255,.04)}
    .card .body{padding:14px 16px}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    @media (max-width:980px){.kpis{grid-template-columns:1fr 1fr}}
    .kpi{background:#10193a;border:1px solid #26306a;border-radius:12px;padding:12px;display:grid;gap:4px}
    .kpi .label{font-size:12px;color:#b7c2ff}
    .kpi .value{font-size:26px;font-weight:900}
    .bar{height:12px;background:#0e1628;border:1px solid #1f2a41;border-radius:8px;overflow:hidden}
    .bar span{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#7aa2ff)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:#b7c2ff;text-align:left}
    td,th{padding:8px 10px}
    tr{background:#0f1633;border:1px solid #26306a}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:var(--muted)} .small{font-size:12px}
    .note{background:#0f172a;border:1px dashed #334155;padding:12px;border-radius:10px;color:#cbd5e1}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#27306a,transparent);margin:10px 0}
    .toast{position:fixed;right:16px;bottom:16px;z-index:80;display:grid;gap:8px}
    .toast .t{background:#111b39;color:#dbe7ff;border:1px solid #29408f;padding:10px 12px;border-radius:10px;box-shadow:var(--shadow)}
    /* --- Top Tabs --- */
    .tabs{position:sticky;top:56px;z-index:45;background:radial-gradient(80% 200px at 50% 0, rgba(96,165,250,.08), transparent 60%);border-bottom:1px solid #1f2937}
    .tabs .wrap{max-width:var(--max);margin:0 auto;padding:14px 24px;display:flex;gap:10px;align-items:center}
    .tab-btn{appearance:none;border:1px solid #2a3a6c;background:linear-gradient(180deg,#0f1b3b,#0b1326);color:#cfe3ff;padding:.65rem 1rem;font-weight:800;border-radius:999px;cursor:pointer;letter-spacing:.2px}
    .tab-btn[aria-selected="true"]{background:linear-gradient(180deg,#7aa2ff,#5b7cff);color:#0a0a0a;border-color:#3454d1;box-shadow:0 8px 24px rgba(96,165,250,.35)}
    .tab-btn:focus{outline:2px solid #3454d1;outline-offset:2px}
    .tab-spacer{flex:1}
    .panel{display:none}
    .panel.active{display:block}
  </style>
</head>
<body>
  <header>
    <div class="nav container" role="navigation" aria-label="Primary">
      <div class="brand">
        <span aria-hidden>üõ°Ô∏è</span>
        <div>
          <div style="font-weight:900">MilFi</div>
          <div class="small muted">Finance Dashboard ‚Äî Integrated</div>
        </div>
        <span class="badge">Local & Private</span>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <a class="btn" href="https://tnolan1219.github.io/TKN-Financial-V.3/">Home</a>
        <a class="btn" href="Investing_Home.html">‚Üê Back</a>

        <button class="btn ghost" id="demoBtn">Load Demo</button>
        <button class="btn danger" id="clearBtn">Clear</button>
        <button class="btn" id="refreshBtn" >üîÑ Refresh Data</button>

      </div>
    </div>
  </header>

  <div class="tabs" role="tablist" aria-label="Finance sections">
    <div class="wrap">
      <button class="tab-btn" role="tab" id="tabbtn-overview" aria-selected="true" aria-controls="tab-overview">Overview</button>
      <button class="tab-btn" role="tab" id="tabbtn-investing" aria-selected="false" aria-controls="tab-investing">Investing</button>
      <button class="tab-btn" role="tab" id="tabbtn-cashflow" aria-selected="false" aria-controls="tab-cashflow">Cash Flow</button>
      <button class="tab-btn" role="tab" id="tabbtn-tsp" aria-selected="false" aria-controls="tab-tsp">TSP</button>
      <button class="tab-btn" role="tab" id="tabbtn-debts" aria-selected="false" aria-controls="tab-debts">Debts</button>
      <button class="tab-btn" role="tab" id="tabbtn-goals" aria-selected="false" aria-controls="tab-goals">Goals</button>
      <span class="tab-spacer"></span>
    </div>
  </div>

  <main class="container" id="main">
    <!-- OVERVIEW PANEL -->
    <section id="tab-overview" class="panel active" role="tabpanel" aria-labelledby="tabbtn-overview">
      <!-- Overview Row -->
      <section class="grid two">
        <article class="card" aria-labelledby="planTitle">
          <div class="head" id="planTitle">Plan & Monthly Usage</div>
          <div class="body">
            <div class="grid two" style="align-items:end">
              <div>
                <div class="small muted">Current plan</div>
                <div style="font-size:22px;font-weight:900" id="plan">Free</div>
                <div class="small muted">Period: <span id="period">‚Äî</span></div>
                <div class="divider"></div>
                <div class="small muted">Global runs this month</div>
                <div class="bar" aria-label="Global usage"><span id="globalBar"></span></div>
                <div class="small muted" id="globalNote" style="margin-top:6px">‚Äî</div>
              </div>
              <div style="display:grid;gap:8px;justify-content:end">
                <a class="btn primary" id="upgrade" href="pages/profile.html">Upgrade to Pro</a>
                <a class="btn ghost" id="downgrade" href="pages/profile.html">Switch to Free</a>
              </div>
            </div>
            <p class="note" style="margin-top:12px">Free plan: 25 runs/month total, soft cap 5 per tool. Pro: Unlimited. (Demo toggle here only affects your browser.)</p>
          </div>
        </article>

        <article class="card" aria-labelledby="quickTitle">
          <div class="head" id="quickTitle">Quick Actions</div>
          <div class="body" style="display:grid;gap:8px;grid-template-columns:repeat(2,1fr)">
            <a class="btn" href="milfi_toolkit.html">All‚Äëin‚ÄëOne Toolkit</a>
            <a class="btn" href="BudgetFire_2.html">Budget Tool</a>
            <a class="btn" href="TSP_CSL_Calc.html">TSP & Career Starter Loan</a>
            <a class="btn" href="Investing_Home.html">Investing Hub</a>
          </div>
        </article>
      </section>

      <!-- Snapshot KPIs -->
      <section class="card" aria-labelledby="kpiTitle" style="margin-top:10px">
        <div class="head" id="kpiTitle">Snapshot ‚Äî Your Finances at a Glance</div>
        <div class="body kpis">
          <div class="kpi"><div class="label">Net Worth</div><div class="value" id="kpiNW">‚Äî</div></div>
          <div class="kpi"><div class="label">Savings Rate</div><div class="value" id="kpiSaveRate">‚Äî</div></div>
          <div class="kpi"><div class="label">Cash Flow (monthly)</div><div class="value" id="kpiCashFlow">‚Äî</div></div>
          <div class="kpi"><div class="label">FIRE Progress</div><div class="value" id="kpiFire">‚Äî</div><div class="bar" aria-label="FIRE progress"><span id="fireBar"></span></div></div>
        </div>
      </section>

      <!-- Usage by Tool (added back) -->
      <section class="card" aria-labelledby="usageTitle" style="margin-top:10px">
        <div class="head" id="usageTitle">Usage by Tool</div>
        <div class="body" style="overflow-x:auto">
          <table aria-label="Tool usage table">
            <thead><tr><th>Tool</th><th>Uses</th><th>Limit</th><th style="width:300px">Progress</th><th>Action</th></tr></thead>
            <tbody id="usageRows"></tbody>
          </table>
          <div class="small muted" style="margin-top:6px">Soft cap is 5 per tool on Free. Colors: <span style="color:var(--ok)">OK</span> ‚Ä¢ <span style="color:var(--warn)">Warn</span> ‚Ä¢ <span style="color:var(--bad)">Over</span>.</div>
        </div>
      </section>
    </section>

    <!-- INVESTING PANEL -->
    <section id="tab-investing" class="panel" role="tabpanel" aria-labelledby="tabbtn-investing">
      <section class="grid two" style="margin-top:10px">
        <article class="card">
          <div class="head">Retirement / FIRE Overview</div>
          <div class="body">
            <div class="grid two">
              <div>
                <div class="small muted">Targets</div>
                <ul style="list-style:none;margin:6px 0 0;padding:0;display:grid;gap:6px">
                  <li>Lean FI: <b id="fiLean">‚Äî</b></li>
                  <li>Base FI: <b id="fiBase">‚Äî</b></li>
                  <li>Freedom: <b id="fiFat">‚Äî</b></li>
                </ul>
              </div>
              <div>
                <div class="small muted">Status</div>
                <ul style="list-style:none;margin:6px 0 0;padding:0;display:grid;gap:6px">
                  <li>Current Invested: <b id="fiBal">‚Äî</b></li>
                  <li>Progress to Base: <b id="fiPct">‚Äî</b></li>
                  <li>Est. Years to FI: <b id="fiYears">‚Äî</b></li>
                </ul>
              </div>
            </div>
            <div class="bar" style="margin-top:10px"><span id="fiBar"></span></div>
            <div class="small muted" style="margin-top:6px">Data from FIRE Calculator snapshots.</div>
          </div>
        </article>
        <article class="card">
          <div class="head">TSP Snapshot</div>
          <div class="body">
            <ul style="list-style:none;margin:6px 0 0;padding:0;display:grid;gap:6px">
              <li>Contribution %: <b id="tspPct">‚Äî</b> (<span id="tspOnTrack" class="small muted">‚Äî</span>)</li>
              <li>Balance: <b id="tspBal">‚Äî</b></li>
            </ul>
            <p class="muted small" style="margin-top:6px">Set contribution in the TSP tool; balance can be entered or synced manually in that tool.</p>
          </div>
        </article>
      </section>
    </section>

    <!-- CASH FLOW PANEL -->
    <section id="tab-cashflow" class="panel" role="tabpanel" aria-labelledby="tabbtn-cashflow">
      <section class="card" aria-labelledby="budTitle" style="margin-top:10px">
        <div class="head" id="budTitle">Budget Summary (from saved Budget Tool)</div>
        <div class="body">
          <div class="grid two">
            <div>
              <div class="small muted">Totals</div>
              <ul style="list-style:none;margin:6px 0 0;padding:0;display:grid;gap:6px">
                <li>Monthly Income: <b id="sumIncome">‚Äî</b></li>
                <li>Monthly Expenses: <b id="sumExpenses">‚Äî</b></li>
                <li>Monthly Investing: <b id="sumInvesting">‚Äî</b></li>
                <li>Net Cash After Investing: <b id="sumNet">‚Äî</b></li>
                <li>Gross Savings Rate: <b id="sumSaveRate">‚Äî</b></li>
              </ul>
            </div>
            <div>
              <div class="small muted">By Category</div>
              <svg id="budgetChart" viewBox="0 0 360 180" width="100%" height="180" role="img" aria-label="Budget category bars"></svg>
              <div class="small muted" id="budgetLegend" style="margin-top:6px">‚Äî</div>
            </div>
          </div>
          <p class="muted small" style="margin-top:8px">Tip: Open the Budget Tool and save a snapshot to populate this section.</p>
        </div>
      </section>
    </section>

    <!-- TSP PANEL (focused) -->
    <section id="tab-tsp" class="panel" role="tabpanel" aria-labelledby="tabbtn-tsp">
      <section class="card" style="margin-top:10px">
        <div class="head">TSP Snapshot</div>
        <div class="body">
          <ul style="list-style:none;margin:6px 0 0;padding:0;display:grid;gap:6px">
            <li>Contribution %: <b id="tspPct2">‚Äî</b> (<span id="tspOnTrack2" class="small muted">‚Äî</span>)</li>
            <li>Balance: <b id="tspBal2">‚Äî</b></li>
          </ul>
          <p class="muted small" style="margin-top:6px">This mirrors the Investing tab‚Äôs TSP card.</p>
        </div>
      </section>
    </section>

    <!-- DEBTS PANEL -->
    <section id="tab-debts" class="panel" role="tabpanel" aria-labelledby="tabbtn-debts">
      <section class="card" aria-labelledby="starterTitle" style="margin-top:10px">
        <div class="head" id="starterTitle">Career Starter Loan</div>
        <div class="body">
          <ul style="list-style:none;margin:6px 0 0;padding:0;display:grid;gap:6px">
            <li>Current Balance: <b id="stBal">‚Äî</b></li>
            <li>Monthly Payment: <b id="stPmt">‚Äî</b></li>
            <li>APR: <b id="stApr">‚Äî</b></li>
            <li>Invested Portion (if applicable): <b id="stInvested">‚Äî</b></li>
          </ul>
          <p class="muted small" style="margin-top:6px">Populate by saving inside the Starter Loan tool.</p>
        </div>
      </section>
    </section>

    <!-- GOALS PANEL -->
    <section id="tab-goals" class="panel" role="tabpanel" aria-labelledby="tabbtn-goals">
      <section class="card" aria-labelledby="checkTitle" style="margin-top:10px">
        <div class="head" id="checkTitle">Goals & Checklist</div>
        <div class="body">
          <div style="display:grid;gap:8px;grid-template-columns:1fr auto;align-items:center">
            <div class="small muted">Track these basics. Your progress is saved on this device.</div>
            <div class="small" id="clProgress">Progress: 0/4</div>
          </div>
          <div class="divider"></div>
          <ul id="checklist" style="list-style:none;margin:0;padding:0;display:grid;gap:10px">
            <li><label><input type="checkbox" data-id="tsp5"> Set TSP to 5%+ for match</label></li>
            <li><label><input type="checkbox" data-id="efund"> Build starter emergency fund ($1k ‚Üí 3‚Äì6 mo)</label></li>
            <li><label><input type="checkbox" data-id="budget"> Create BAH/BAS‚Äëaware budget</label></li>
            <li><label><input type="checkbox" data-id="fire"> Run FIRE calculator and save a snapshot</label></li>
          </ul>
          <div class="divider"></div>
          <div class="muted small" style="margin-bottom:8px">Add your own goals below:</div>
          <form id="goalForm" style="display:flex;gap:8px;margin-bottom:10px" onsubmit="addGoal(event)">
            <input type="text" id="goalInput" placeholder="Enter a new goal..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #2a3a6c;background:var(--input);color:var(--text);font-size:1em;">
            <button type="submit" class="btn primary">Add Goal</button>
          </form>
          <ul id="userGoals" style="list-style:none;margin:0;padding:0;display:grid;gap:10px"></ul>
        </div>
      </section>

      <section class="grid two" style="margin-top:10px">
        <article class="card">
          <div class="head">Saved FIRE Snapshots</div>
          <div class="body" id="fireSaves">No snapshots found.</div>
        </article>
        <article class="card">
          <div class="head">Saved Reading Topics</div>
          <div class="body" id="readSaves">No saved topics yet.</div>
        </article>
      </section>

      <section class="card" style="margin-top:10px">
        <div class="head">Privacy & Disclaimer</div>
        <div class="body">
          <p class="note">Your data stays in your browser (localStorage). No logins or uploads.</p>
          <p class="muted small">Education only ‚Äî not financial, tax, or legal advice. Verify with official sources and licensed professionals.</p>
        </div>
      </section>
    </section>
  </main>

  <div class="toast" aria-live="polite" id="toast"></div>

  <script>
    // ====== Helpers ======

    // ====== Refresh Button Logic ======
    document.getElementById('refreshBtn').addEventListener('click', function() {
      refresh();
      toast('Dashboard data refreshed.');
    });

    // ====== Cross-Calculator Sync Logic ======
    // This function is called on refresh and page load
    function syncCalculatorData() {
      // Budget
      renderBudget();
      // FIRE
      renderFire();
      renderFireSaves();
      // TSP
      renderTSP();
      // Starter Loan
      renderStarter();
      // Reading Topics
      renderReading();
      // Usage
      renderUsage();
      // Plan
      updatePlan();
      // Checklist
      updateCL();
    }
    // Call sync on refresh
    function refresh() {
      ensurePeriod();
      syncCalculatorData();
    }
    document.addEventListener('DOMContentLoaded', refresh);

    // ====== Usage Count Enforcement ======
    function checkUsageLimits() {
      const planType = plan();
      const globalLimit = planType === 'Pro' ? Infinity : 25;
      const toolLimit = planType === 'Pro' ? Infinity : 5;
      let totalUses = getInt('milfi_uses');
      TOOL_ROWS.forEach(row => {
        const uses = getInt(row.key);
        const rowEl = document.querySelector(`[data-toolkey="${row.key}"]`);
        if (rowEl) {
          if (uses >= toolLimit) {
            rowEl.classList.add('muted');
            rowEl.title = 'Max uses reached for this tool.';
          } else {
            rowEl.classList.remove('muted');
            rowEl.title = '';
          }
        }
      });
      if (totalUses >= globalLimit) {
        toast('You have reached your monthly usage limit for your plan.');
      }
    }
    // Call usage check after usage is rendered
    function renderUsage() {
      const tbody=el('usageRows'); if(!tbody) return; tbody.innerHTML=''; const p=plan(); TOOL_ROWS.forEach(row=>{
        const uses=getInt(row.key);
        const tr=document.createElement('tr');
        tr.setAttribute('data-toolkey', row.key);
        const limit=(p==='Pro')?'Unlimited':TOOL_CAP_FREE;
        const pct=(p==='Pro')?0:(uses/TOOL_CAP_FREE*100);
        tr.innerHTML=`<td>${row.name}</td><td>${uses}</td><td>${limit}</td><td><div class="bar" title="${uses} / ${limit}"><span style="width:${p==='Pro'?'100':Math.min(100,pct)}%; background:${p==='Pro'?'linear-gradient(90deg,#60a5fa,#7aa2ff)':'linear-gradient(90deg,#f59e0b,#fbbf24)'}"></span></div></td>`;
        tbody.appendChild(tr);
      });
      checkUsageLimits();
    }

    // ====== User Goals Logic ======
    const GOALS_KEY = 'milfi_user_goals';
    function loadUserGoals() {
      try { return JSON.parse(localStorage.getItem(GOALS_KEY) || '[]'); } catch { return []; }
    }
    function saveUserGoals(goals) {
      localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    }
    function renderUserGoals() {
      const list = el('userGoals');
      if (!list) return;
      const goals = loadUserGoals();
      if (!goals.length) { list.innerHTML = '<li class="muted small">No custom goals yet.</li>'; return; }
      list.innerHTML = '';
      goals.forEach((goal, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="checkbox" data-idx="${idx}" ${goal.done ? 'checked' : ''}> ${goal.text}</label> <button class="btn danger small" style="float:right" onclick="removeGoal(${idx})">Remove</button>`;
        list.appendChild(li);
      });
      // Checkbox listeners
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function() {
          const goals = loadUserGoals();
          const idx = parseInt(cb.dataset.idx);
          if (goals[idx]) { goals[idx].done = cb.checked; saveUserGoals(goals); }
        });
      });
    }
    function addGoal(e) {
      e.preventDefault();
      const input = el('goalInput');
      if (!input || !input.value.trim()) return toast('Enter a goal.');
      const goals = loadUserGoals();
      goals.push({ text: input.value.trim(), done: false });
      saveUserGoals(goals);
      input.value = '';
      renderUserGoals();
      toast('Goal added!');
    }
    function removeGoal(idx) {
      const goals = loadUserGoals();
      goals.splice(idx, 1);
      saveUserGoals(goals);
      renderUserGoals();
      toast('Goal removed.');
    }
    document.addEventListener('DOMContentLoaded', renderUserGoals);
    const $ = (sel)=>document.querySelector(sel);
    const el = (id)=>document.getElementById(id);
    const fmt = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
    const periodStr = ()=>new Date().toISOString().slice(0,7); // YYYY-MM
    function toast(msg){ const t=document.createElement('div'); t.className='t'; t.textContent=msg; el('toast').appendChild(t); setTimeout(()=>t.remove(),3000); }
    function getInt(key){ return parseInt(localStorage.getItem(key)||'0',10)||0; }
    function setInt(key,val){ localStorage.setItem(key,String(val|0)); }
    function plan(){ return localStorage.getItem('milfi_plan')||'Free'; }
    function setPlan(p){ localStorage.setItem('milfi_plan',p); }

    // Limits
    const GLOBAL_LIMIT_FREE = 25; const TOOL_CAP_FREE = 5;
    const TOOL_ROWS = [
      {key:'milfi_uses_toolkit', name:'All‚Äëin‚ÄëOne Toolkit', href: 'milfi_toolkit.html'},
      {key:'milfi_uses_budget',  name:'Budget Tool', href:'budgetfire_2.html'},
      {key:'milfi_uses_tsp',     name:'TSP Planner', href:'tsp_csl_calc.html'},
      {key:'milfi_uses_va',      name:'VA Loan Tool', href:'reaking/VA_Loan_Calc.html'},
      {key:'milfi_uses_starter', name:'Career Starter Loan', href:'tsp_csl_calc.html#starter'},
      {key:'milfi_uses_fire',    name:'FIRE Calculator', href:'budgetfire_2.html#fire'}
    ];

    // ====== Month rollover ======
    function ensurePeriod(){ const now = periodStr(); const cur = localStorage.getItem('milfi_usage_period'); if(cur === now) return; localStorage.setItem('milfi_usage_period', now); setInt('milfi_uses', 0); TOOL_ROWS.forEach(r=>setInt(r.key, 0)); toast('New month detected. Usage counters reset.'); }

    // ====== Bars ======
    function setBar(elSpan, ratio){ if(!elSpan) return; elSpan.style.width = Math.min(100, Math.max(0, ratio*100)) + '%'; const pct = ratio*100; elSpan.style.background = pct<70? 'linear-gradient(90deg,#34d399,#10b981)' : (pct<100? 'linear-gradient(90deg,#f59e0b,#fbbf24)' : 'linear-gradient(90deg,#ef476f,#ef4444)'); }

    // ====== Snapshot KPIs ======
    function readBudget(){
      // Try new Budget_2.html payload first
      try {
        const raw = localStorage.getItem('budget_fire_payload');
        if (raw) {
          const data = JSON.parse(raw);
          // Map to dashboard format
          const income = { netIncome: data.netIncome || 0, otherIncome: data.otherIncome || 0 };
          let incomeObj = {};
          if (income.netIncome) incomeObj['Net Income'] = income.netIncome;
          if (income.otherIncome) incomeObj['Other Income'] = income.otherIncome;
          // Expenses and Investing
          let expensesObj = {}, investingObj = {};
          (data.rows||[]).forEach(row => {
            if (/invest/i.test(row.cat) || /savings/i.test(row.cat)) {
              investingObj[row.cat] = row.planned || 0;
            } else {
              expensesObj[row.cat] = row.planned || 0;
            }
          });
          return { income: incomeObj, expenses: expensesObj, investing: investingObj };
        }
      } catch(e){}
      // Fallback to old snapshot
      try{ return JSON.parse(localStorage.getItem('milfi_budget_snapshot')||''); }catch{return null}
    }
    function sumMap(m){ if(!m) return 0; return Object.values(m).map(x=>+x||0).reduce((a,b)=>a+b,0); }
    function numToMoneyOrDash(n){ return (typeof n==='number' && !isNaN(n)) ? fmt.format(n) : '‚Äî'; }
    function readFire(){
      // Try new FIRE payload from Budget_2.html
      try {
        const raw = localStorage.getItem('fire_projection_payload');
        if (raw) {
          const data = JSON.parse(raw);
          const fi = data.fi || {};
          // Estimate base, lean, fat from withdrawal rate and spend
          const spend = fi.spend || 0;
          const wr = fi.wr || 4;
          const base = wr > 0 ? (spend * 12) / (wr / 100) : 0;
          const lean = base * 0.8;
          const fat = base * 1.25;
          const bal = fi.current || 0;
          const pct = base > 0 ? Math.min(1, bal / base) : 0;
          return { base, lean, fat, bal, pct };
        }
      } catch(e){}
      // Fallback to old snapshot
      try{ const fire = JSON.parse(localStorage.getItem('milfi_fire')||'{}'); const base = +fire.base||0, lean=+fire.lean||0, fat=+fire.fat||0; let bal=+fire.bal||0; if(!bal && Array.isArray(fire.series) && fire.series.length) bal = +fire.series[fire.series.length-1]||0; const pct = base>0? Math.min(1, bal/base):0; return {base,lean,fat,bal,pct}; }catch{ return {base:0,lean:0,fat:0,bal:0,pct:0}; }
    }

    function updateSnapshot(){
      // Net worth
      const assets = parseFloat(localStorage.getItem('milfi_assets_total')||'')||null;
      const debts  = parseFloat(localStorage.getItem('milfi_debts_total')||'')||null;
      const nwEl = el('kpiNW'); if(nwEl) nwEl.textContent = (assets!=null && debts!=null)? fmt.format(assets - debts) : '‚Äî';
      // Budget-derived
      const b = readBudget();
      if(b){ const income=sumMap(b.income), expenses=sumMap(b.expenses), investing=sumMap(b.investing); const net = income - expenses - investing; const cfEl=el('kpiCashFlow'); if(cfEl) cfEl.textContent=numToMoneyOrDash(net); const sr = income>0? (investing/income*100):null; const srEl=el('kpiSaveRate'); if(srEl) srEl.textContent = sr!=null? sr.toFixed(0)+'%' : '‚Äî'; } else { const cfEl=el('kpiCashFlow'); if(cfEl) cfEl.textContent='‚Äî'; const srEl=el('kpiSaveRate'); if(srEl) srEl.textContent='‚Äî'; }
      // FIRE progress
      const f = readFire(); const kEl=el('kpiFire'); if(f.base>0){ if(kEl) kEl.textContent=(f.pct*100).toFixed(0)+'%'; setBar(el('fireBar'), f.pct); } else { if(kEl) kEl.textContent='‚Äî'; const fb=el('fireBar'); if(fb) fb.style.width='0%'; }
    }

    // ====== Budget Summary render ======
    function renderBudget(){
      const b = readBudget();
      const incEl=el('sumIncome'), expEl=el('sumExpenses'), invEl=el('sumInvesting'), netEl=el('sumNet'), rateEl=el('sumSaveRate');
      // Totals
      if(!b){ if(incEl) incEl.textContent='‚Äî'; if(expEl) expEl.textContent='‚Äî'; if(invEl) invEl.textContent='‚Äî'; if(netEl) netEl.textContent='‚Äî'; if(rateEl) rateEl.textContent='‚Äî'; const chart=el('budgetChart'); if(chart) chart.innerHTML=''; const leg=el('budgetLegend'); if(leg) leg.textContent='‚Äî'; return; }
      const income=sumMap(b.income), expenses=sumMap(b.expenses), investing=sumMap(b.investing);
      const net=income-expenses-investing; const rate=income>0? (investing/income*100):null;
      if(incEl) incEl.textContent=fmt.format(income); if(expEl) expEl.textContent=fmt.format(expenses); if(invEl) invEl.textContent=fmt.format(investing); if(netEl) netEl.textContent=fmt.format(net); if(rateEl) rateEl.textContent=rate!=null? rate.toFixed(0)+'%':'‚Äî';

      // --- Bar chart (color‚Äëcoded, labeled) ---
      const cats = b.expenses? Object.entries(b.expenses):[];
      // sort by value descending for clarity
      cats.sort((a,b)=>(+b[1]||0)-(+a[1]||0));
      const chart=el('budgetChart'); if(!chart){ return; }
      const W=360, H=180, M={t:10,r:10,b:46,l:20};
      const innerW=W-M.l-M.r, innerH=H-M.t-M.b;
      const max = Math.max(1, ...cats.map(([k,v])=>+v||0));
      const n = Math.max(1,cats.length);
      const gap = 8;
      const barW = Math.max(18, Math.min(40, Math.floor((innerW - (n-1)*gap)/n)));
      const palette = ['#60a5fa','#34d399','#fbbf24','#ef476f','#a78bfa','#f472b6','#22d3ee','#c084fc','#fb7185','#f59e0b'];

      let x = M.l;
      let svg = ``;
      // baseline
      svg += `<rect x="0" y="0" width="${W}" height="${H}" fill="transparent" />`;
      svg += `<line x1="${M.l}" y1="${M.t+innerH}" x2="${W-M.r}" y2="${M.t+innerH}" stroke="#24304f" stroke-width="1" />`;

      cats.forEach(([label,val],i)=>{
        const v = +val || 0;
        const h = Math.round((v/max) * innerH);
        const x0 = x; const y0 = M.t + (innerH - h);
        const color = palette[i % palette.length];
        // bar
        svg += `<rect x="${x0}" y="${y0}" width="${barW}" height="${h}" rx="5" fill="${color}" />`;
        // value above bar
        svg += `<text x="${x0 + barW/2}" y="${y0-6}" fill="#dbe7ff" font-size="10" text-anchor="middle">${fmt.format(v)}</text>`;
        // label under bar ‚Äî wrap to 10 chars with ellipsis
        const name = String(label);
        const short = name.length>12 ? name.slice(0,12)+'‚Ä¶' : name;
        svg += `<text x="${x0 + barW/2}" y="${M.t+innerH+14}" fill="#9fb6e9" font-size="10" text-anchor="middle">${short}</text>`;
        x += barW + gap;
      });
      chart.innerHTML = svg;

      // Legend with color swatches
      const leg=el('budgetLegend');
      if(leg){
        if(!cats.length){ leg.textContent='‚Äî'; }
        else{
          leg.innerHTML = cats.map(([k,v],i)=>{
            const color = palette[i % palette.length];
            return `<span style="display:inline-flex;align-items:center;gap:6px;margin-right:12px;margin-top:6px"><span style="width:10px;height:10px;background:${color};border-radius:2px;display:inline-block"></span>${k}: <b>${fmt.format(+v||0)}</b></span>`;
          }).join('');
        }
      }
    }

    // ====== FIRE details ======
    function renderFire(){ const f=readFire(); const lean=el('fiLean'), base=el('fiBase'), fat=el('fiFat'), bal=el('fiBal'), pct=el('fiPct'), yrs=el('fiYears'); if(lean) lean.textContent=f.lean?fmt.format(f.lean):'‚Äî'; if(base) base.textContent=f.base?fmt.format(f.base):'‚Äî'; if(fat) fat.textContent=f.fat?fmt.format(f.fat):'‚Äî'; if(bal) bal.textContent=f.bal?fmt.format(f.bal):'‚Äî'; if(pct) pct.textContent=f.base?(f.pct*100).toFixed(0)+'%':'‚Äî'; setBar(el('fiBar'), f.pct); const b=readBudget(); const investing=b?sumMap(b.investing):0; const annualAdd=Math.max(0,investing*12); let years='‚Äî'; if(f.base>0 && annualAdd>0){ const remain=Math.max(0,f.base-f.bal); years=(remain/annualAdd).toFixed(1);} if(yrs) yrs.textContent=years; }

    // ====== TSP ======
    function renderTSP(){ const pctStr=(function(){ const pct=localStorage.getItem('milfi_tsp_contrib_pct'); return pct? (parseFloat(pct).toFixed(1)+'%'):'‚Äî'; })(); const onTrackStr=(function(){ const pct=localStorage.getItem('milfi_tsp_contrib_pct'); return pct? (parseFloat(pct)>=5?'On track for full match':'Below 5% match'):'‚Äî'; })(); const bal=parseFloat(localStorage.getItem('milfi_tsp_balance')||''); const balStr=isNaN(bal)?'‚Äî':fmt.format(bal); ['tspPct','tspPct2'].forEach(id=>{ const n=el(id); if(n) n.textContent=pctStr; }); ['tspOnTrack','tspOnTrack2'].forEach(id=>{ const n=el(id); if(n) n.textContent=onTrackStr; }); ['tspBal','tspBal2'].forEach(id=>{ const n=el(id); if(n) n.textContent=balStr; }); }

    // ====== Starter Loan ======
    function renderStarter(){ let s=null; try{ s=JSON.parse(localStorage.getItem('milfi_starter')||''); }catch{} const ids=['stBal','stPmt','stApr','stInvested']; if(!s){ ids.forEach(i=>{ const n=el(i); if(n) n.textContent='‚Äî'; }); return;} const nBal=el('stBal'), nP=el('stPmt'), nA=el('stApr'), nI=el('stInvested'); if(nBal) nBal.textContent=(typeof s.balance==='number')? fmt.format(s.balance):'‚Äî'; if(nP) nP.textContent=(typeof s.payment==='number')? fmt.format(s.payment):'‚Äî'; if(nA) nA.textContent=(typeof s.apr==='number')? (s.apr.toFixed(2)+'%'):'‚Äî'; if(nI) nI.textContent=(typeof s.invested==='number')? fmt.format(s.invested) : (s.invested? String(s.invested):'‚Äî'); }

    // ====== Plan & usage ======
    function updatePlan(){ const p=plan(); const pEl=el('plan'); if(pEl) pEl.textContent=p; const perEl=el('period'); if(perEl) perEl.textContent=localStorage.getItem('milfi_usage_period')||periodStr(); const total=getInt('milfi_uses'); if(p==='Pro'){ const n=el('globalNote'); if(n) n.textContent=`Unlimited ‚Ä¢ ${total} run(s) logged`; const s=el('globalBar'); if(s){ s.style.width='100%'; s.style.background='linear-gradient(90deg,#60a5fa,#7aa2ff)'; } } else { const left=Math.max(0,GLOBAL_LIMIT_FREE-total); const n=el('globalNote'); if(n) n.textContent=`${total} / ${GLOBAL_LIMIT_FREE} ‚Ä¢ ${left} left`; setBar(el('globalBar'), total/GLOBAL_LIMIT_FREE); } }

    function renderUsage(){ const tbody=el('usageRows'); if(!tbody) return; tbody.innerHTML=''; const p=plan(); TOOL_ROWS.forEach(row=>{ const uses=getInt(row.key); const tr=document.createElement('tr'); const limit=(p==='Pro')?'Unlimited':TOOL_CAP_FREE; const pct=(p==='Pro')?0:(uses/TOOL_CAP_FREE*100); tr.innerHTML=`<td>${row.name}</td><td>${uses}</td><td>${limit}</td><td><div class="bar" title="${uses} / ${limit}"><span style="width:${p==='Pro'?'100':Math.min(100,pct)}%; background:${p==='Pro'?'linear-gradient(90deg,#60a5fa,#7aa2ff)':(pct<70?'linear-gradient(90deg,#34d399,#10b981)':(pct<100?'linear-gradient(90deg,#f59e0b,#fbbf24)':'linear-gradient(90deg,#ef476f,#ef4444)'))}"></span></div></td><td><a class="btn" href="${row.href}">Open</a></td>`; tbody.appendChild(tr); }); }

    // ====== Checklist ======
    const CL_KEY='milfi_finance_checklist';
    function loadCL(){ try{return JSON.parse(localStorage.getItem(CL_KEY)||'{}')}catch{return{}} }
    function saveCL(x){ localStorage.setItem(CL_KEY, JSON.stringify(x)); }
    function updateCL(){ const map=loadCL(); document.querySelectorAll('#checklist input[type="checkbox"]').forEach(cb=>{ cb.checked=!!map[cb.dataset.id]; }); const total=document.querySelectorAll('#checklist input').length; const done=Object.values(map).filter(Boolean).length; const p=el('clProgress'); if(p) p.textContent=`Progress: ${done}/${total}`; }

    // ====== Saved Items ======
    function renderFireSaves(){ let list=[]; try{ list=JSON.parse(localStorage.getItem('milfi_fire__list')||'[]'); }catch{} const box=el('fireSaves'); if(!box) return; if(!list.length){ box.textContent='No snapshots found.'; return;} box.innerHTML=''; list.slice().reverse().forEach(s=>{ const d=document.createElement('div'); d.style.cssText='margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid #26306a;border-radius:10px'; const when=new Date(s.when||Date.now()).toLocaleString(); d.innerHTML=`<div><b>${when}</b></div><div class="small muted">Spend ${fmt.format(s.spend||0)} ‚Ä¢ Other ${fmt.format(s.other||0)} ‚Ä¢ SWR ${s.swr||'‚Äî'}%</div><div>Base ${fmt.format(s.base||0)} | Lean ${fmt.format(s.lean||0)} | Freedom ${fmt.format(s.fat||0)}</div><div class="small muted" style="margin-top:6px">Load snapshots inside the FIRE tool for full charts.</div>`; box.appendChild(d); }); }
    function renderReading(){ let ids=[]; try{ ids=JSON.parse(localStorage.getItem('milfi_saved_topics')||'[]'); }catch{} const box=el('readSaves'); if(!box) return; if(!ids.length){ box.textContent='No saved topics yet.'; return;} const ul=document.createElement('ul'); ul.style.margin='0'; ul.style.paddingLeft='18px'; ids.forEach(id=>{ const li=document.createElement('li'); li.textContent=id; ul.appendChild(li); }); box.innerHTML=''; box.appendChild(ul); }

    // ====== Demo & Clear ======
    function loadDemo(){ setPlan('Free'); localStorage.setItem('milfi_usage_period', periodStr()); setInt('milfi_uses', 20); setInt('milfi_uses_toolkit', 4); setInt('milfi_uses_budget', 5); setInt('milfi_uses_tsp', 3); setInt('milfi_uses_va', 2); setInt('milfi_uses_starter', 1); setInt('milfi_uses_fire', 6); localStorage.setItem('milfi_assets_total','85000'); localStorage.setItem('milfi_debts_total','25000'); localStorage.setItem('milfi_tsp_contrib_pct','6'); localStorage.setItem('milfi_tsp_balance','32000'); localStorage.setItem('milfi_budget_snapshot', JSON.stringify({ income:{basePay:3600, BAH:2200, BAS:452, other:200}, expenses:{housing:2100, utilities:250, food:600, transport:350, insurance:220, debt:180, other:200}, investing:{tsp:450, roth:250, brokerage:150} })); localStorage.setItem('milfi_fire', JSON.stringify({base:400000, lean:320000, fat:500000, bal:120000, series:[100000,110000,120000]})); localStorage.setItem('milfi_fire__list', JSON.stringify([{when: new Date().toISOString(), spend:36000, other:0, swr:4, base:400000, lean:320000, fat:500000}])); localStorage.setItem('milfi_starter', JSON.stringify({balance:6500, payment:190, apr:0.99, invested:2000})); toast('Demo data loaded.'); refresh(); }
    function clearDashboardData(){ if(!confirm('Clear dashboard-related keys? This will not remove your other page data.')) return; const keys=['milfi_usage_period','milfi_uses','milfi_uses_toolkit','milfi_uses_budget','milfi_uses_tsp','milfi_uses_va','milfi_uses_starter','milfi_uses_fire','milfi_finance_checklist']; keys.forEach(k=>localStorage.removeItem(k)); toast('Dashboard data cleared.'); refresh(); }

    // ====== Tabs ======
    const TABS = ['overview','investing','cashflow','tsp','debts','goals'];
    function setActiveTab(id){
      TABS.forEach(t=>{
        const btn = document.getElementById('tabbtn-'+t);
        const panel = document.getElementById('tab-'+t);
        const on = (t===id);
        if(btn){ btn.setAttribute('aria-selected', on?'true':'false'); }
        if(panel){ panel.classList.toggle('active', on); }
      });
    }
    function goTabFromHash(){ const hash = (location.hash||'').replace('#',''); const id = TABS.includes(hash)? hash : 'overview'; setActiveTab(id); }
    window.addEventListener('hashchange', goTabFromHash);
    document.addEventListener('click', (e)=>{ const b = e.target.closest('.tab-btn'); if(!b) return; const id=b.id.replace('tabbtn-',''); location.hash = id; e.preventDefault(); });

    // ====== Sanity checks (helps catch missing IDs early) ======
    function sanityCheck(){
      const requiredIds=['plan','period','globalBar','globalNote','kpiNW','kpiSaveRate','kpiCashFlow','kpiFire','fireBar','usageRows','sumIncome','sumExpenses','sumInvesting','sumNet','sumSaveRate','budgetChart','budgetLegend','fiLean','fiBase','fiFat','fiBal','fiPct','fiYears','fiBar','tspPct','tspOnTrack','tspBal','tspPct2','tspOnTrack2','tspBal2','stBal','stPmt','stApr','stInvested','clProgress'];
      const missing = requiredIds.filter(id=>!document.getElementById(id));
      if(missing.length){ console.warn('Dashboard missing elements:', missing); }
    }

    // ====== Refresh & Events ======
    function refresh(){ ensurePeriod(); updatePlan(); updateSnapshot(); renderUsage(); renderFireSaves(); renderReading(); updateCL(); renderBudget(); renderFire(); renderTSP(); renderStarter(); }
    el('demoBtn').addEventListener('click', loadDemo);
    el('clearBtn').addEventListener('click', clearDashboardData);
    document.querySelectorAll('#checklist input').forEach(cb=>{ cb.addEventListener('change', ()=>{ const map=(function(){try{return JSON.parse(localStorage.getItem('milfi_finance_checklist')||'{}')}catch{return{}}})(); map[cb.dataset.id]=cb.checked; localStorage.setItem('milfi_finance_checklist', JSON.stringify(map)); updateCL(); }); });

    if(!localStorage.getItem('milfi_usage_period')) localStorage.setItem('milfi_usage_period', periodStr());
    if(!localStorage.getItem('milfi_plan')) setPlan('Free');
    goTabFromHash();
    sanityCheck();
    refresh();
  </script>
</body>
</html>
</body>
</html>


